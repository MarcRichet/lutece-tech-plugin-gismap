<#assign idEntry = "">
<#if entry?? && entry.idEntry?has_content >
	<#assign idEntry = entry.idEntry >
</#if>
<#assign strValPrint = "false" >
<#list map_parameter.parameters?keys as key>
	<#assign strKey = "'" + key + "'">
	<#if strKey == "'Print'">
		<#assign strValPrint = map_parameter.parameters[key] >
	</#if>
</#list>

<#assign strValMapClass = "map" >
<#list map_parameter.parameters?keys as key>
	<#assign strKey = "'" + key + "'">
	<#if strKey == "'MapClass'">
		<#assign strValMapClass = "${map_parameter.parameters[key]}"?split("'")[1] >
	</#if>
</#list>
<#assign strValTypeEdit = "" >
<#if fieldParam?? >
<#list fieldParam?keys as key>
	<#assign strKey = "'" + key + "'">
	<#if strKey == "'TypeEdit'">
		<#assign strValTypeEdit = "'" + fieldParam[key] + "'" >
		<#break>
	</#if>
</#list>
</#if>
<script src="js/autocomplete/jquery.session.js"></script>
<div>
	<input type="hidden" id="${idEntry}_geomCentroidXGeocodage" value=""/>
    <input type="hidden" id="${idEntry}_geomCentroidYGeocodage" value=""/>
    <input type="hidden" id="${idEntry}_geomState" value='false'/>
    
    <input type="hidden" id="${idEntry}_extent_current" name="${idEntry}_extent_current" value="" >
    <input type="hidden" id="${idEntry}_visible_layer" name="${idEntry}_visible_layer" value="" >
    <input type="hidden" name="gismap_entry" value="${idEntry}" > 
    
    <input type="hidden" id="${idEntry}_extent_current_val" name="extent_current_val"  value="">
	<input type="hidden" id="${idEntry}_visible_layer_val" name="visible_layer_val" value="" >
    
    <div id="${idEntry}_map" class="${strValMapClass}"><div id="popup"></div></div>
    
    <button id="zoomSelect" type="button" onClick="GisMapDisplay${idEntry}.getZoom().zoomSelect()">Zoom To</button>
    <#if editModeValue?? && editModeValue=="">
	    <button id="SelectVia" type="button" onClick="selectObjectLuteceViaMap(GisMapDisplay${idEntry}.getInteract().getSpecificInteract().getSpecificSelectedFeatures())">Select Object lutece via Map</button>
	    <button id="SelectTo" type="button" onClick="GisMapDisplay${idEntry}.getInteract().getSpecificInteract().setSpecificSelectedFeatures(selectObjectMapViaLutece())">Select Object Map via Lutece</button>
    </#if>
    <a id="mapPrint" class="btn" download="map.png" <#if strValPrint == "false"> style="display: none" </#if> ><input type="button" value="Print Map"></a>
    
    <!-- <script src="js/gismap/GisTest.js" type="text/javascript"></script> -->
    
    <!-- <script src="js/Gis.js" type="text/javascript"></script> </script> -->
</div>
<script>

$( "#${idEntry}_map" )
.mouseout(function() {
	var typeEdit   = "${strValTypeEdit}";
	if(typeEdit != "''"){
	var varX = $("#${idEntry}_x").val();
	var varY = $("#${idEntry}_y").val();
		if(varX != "" && varY != ""){
			GisMapDisplay${idEntry}.getInteract().getEditor().forceValidate();
			geocodage${idEntry}();
		}
	}
	else{
		var varExtendCurrent = $("#${idEntry}_extent_current").val();
		var varVisibleLayer = $("#${idEntry}_visible_layer").val();
		if(varExtendCurrent != "" && varVisibleLayer != ""){
			$.session.set("extent_current", varExtendCurrent);
			$.session.set("visible_layer", varVisibleLayer);
		}
		
		$("#${idEntry}_extent_current_val").val($.session.get("extent_current"));
		$("#${idEntry}_visible_layer_val").val($.session.get("visible_layer"));

	}
	
});

function selectObjectLuteceViaMap( idSelected ){
	$( ".selected-id" ).each(function(  ) {
		var id = this.value;
		if(inIdSelected(id, idSelected)==true){
			document.getElementById("selected_record_" + id ).checked = true;
		}
		else{
			document.getElementById("selected_record_" + id ).checked = false;
		}
		});
};
function selectObjectMapViaLutece(  ){
	var idSelected = [];
	var i = 0;
	$( ".selected-id" ).each(function(  ) {
		var id = this.value;
		if(document.getElementById("selected_record_" + id ).checked == true){
			idSelected[i] = id;
			i++;
		}
	});
	return idSelected;
};
function inIdSelected(id, idSelected){
	var varBoolean = false;
	for	(index = 0; index < idSelected.length; index++) {
		var idIndex = idSelected[index];
		if(idIndex == id){
			varBoolean = true;
			return varBoolean;
		}
	}
	return varBoolean;
};
function geocodage${idEntry}(){
	var webappURL = $('#webapp_url').val();
	var valX = $('#${entry.idEntry}_geomCentroidXGeocodage').val();
	var valY = $('#${entry.idEntry}_geomCentroidYGeocodage').val();
	$.ajax({
		url: webappURL + "rest/gismap/xy/" + valX + "," + valY,
        dataType: "jsonp",
	    jsonpCallback: 'callback',
        success: function( data ) {
			var address = data.Adresse_tot+", "+data.Codepostal+" ";
        	$("#${entry.idEntry}_address").val(address);
			$("#${entry.idEntry}_additional_address").val(getAdditionalAdd(address));
    	}
    });
};
</script>